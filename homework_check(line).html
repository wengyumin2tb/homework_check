<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ¥­æª¢æ ¸è¡¨ (è‡ªå‹•å­˜æª”)</title>
    <style>
        :root {
            --bg-ok: #ffffff;
            --bg-missing: #ffebee;
            --bg-uncorrected: #fff3e0;
            --text-missing: #c62828;
            --text-uncorrected: #ef6c00;
            --border: #ccc;
            --header-bg: #4a90e2;
        }

        body {
            font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: #eef2f5;
            padding: 10px;
            border-radius: 8px;
        }

        .controls input {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100px;
        }

        .legend {
            font-size: 0.9em;
            margin-left: auto;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .save-status {
            font-size: 14px;
            font-weight: bold;
            color: #2e7d32;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .save-status.show { opacity: 1; }

        /* Table Styles - Grid Layout */
        .table-container {
            overflow: auto;
            max-height: 75vh;
            position: relative;
            border: 1px solid var(--border);
        }

        table {
            border-collapse: separate; 
            border-spacing: 0;
            width: 100%;
        }

        th, td {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            text-align: center;
            padding: 8px 4px;
            font-size: 14px;
            min-width: 30px;
        }

        /* ä¸Šæ–¹å‡çµçª—æ ¼ (åº§è™Ÿ) */
        thead th {
            background-color: var(--header-bg);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 40px;
        }

        /* å·¦å´å‡çµçª—æ ¼ (ç§‘ç›®) */
        tbody th {
            position: sticky;
            left: 0;
            background-color: #f0f7ff;
            z-index: 5;
            text-align: left;
            padding-left: 10px;
            min-width: 120px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            border-right: 2px solid #aaa;
        }

        /* å·¦ä¸Šè§’ç©ºç™½æ ¼ */
        thead th:first-child {
            position: sticky;
            left: 0;
            top: 0;
            z-index: 20;
            background-color: var(--header-bg);
            border-right: 2px solid #aaa;
            min-width: 120px;
        }

        /* é»æ“Šç‹€æ…‹æ¨£å¼ */
        td.cell-clickable {
            cursor: pointer;
            user-select: none;
        }
        td.cell-clickable:hover { background-color: #f0f0f0; }

        td[data-status="1"] { background-color: var(--bg-missing); color: var(--text-missing); font-weight: bold; }
        td[data-status="1"]::after { content: "âœ•"; }

        td[data-status="2"] { background-color: var(--bg-uncorrected); color: var(--text-uncorrected); font-weight: bold; }
        td[data-status="2"]::after { content: "â–³"; }

        td[data-status="0"] { color: #ccc; }

        /* Summary Section */
        .summary-box {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
        }

        button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background-color: #357abd; }
        
        button.reset-btn { background-color: #ef5350; }
        button.reset-btn:hover { background-color: #d32f2f; }

    </style>
</head>
<body>

<div class="container">
    <h1>ä½œæ¥­æª¢æ ¸è¡¨</h1>

    <div class="controls">
        <strong>è‡ªè¨‚ç§‘ç›®ï¼š</strong>
        <input type="text" id="custom1" value="è‡ªè¨‚1" oninput="updateSubjectName(4, this.value)">
        <input type="text" id="custom2" value="è‡ªè¨‚2" oninput="updateSubjectName(5, this.value)">
        <input type="text" id="custom3" value="è‡ªè¨‚3" oninput="updateSubjectName(6, this.value)">
        
        <div class="legend">
            <span class="save-status" id="saveMsg">ğŸ’¾ å·²å„²å­˜</span>
            <span><div class="dot" style="background:#ffebee; border:1px solid red"></div> âœ• æœªäº¤</span>
            <span><div class="dot" style="background:#fff3e0; border:1px solid orange"></div> â–³ æœªè¨‚æ­£</span>
        </div>
        <button class="reset-btn" onclick="resetNewDay()">æ–°çš„ä¸€å¤© (æ¸…ç©ºè¨˜è™Ÿ)</button>
    </div>

    <div class="table-container">
        <table id="homeworkTable">
            <thead>
                <tr>
                    <th style="font-size:1.1em;">ç§‘ç›® \ åº§è™Ÿ</th>
                    </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div class="summary-box">
        <div class="summary-header">
            <h3>ğŸ“Š çµ±è¨ˆçµæœ</h3>
            <button onclick="copySummary()">è¤‡è£½å…§å®¹</button>
        </div>
        <textarea id="summaryText" readonly></textarea>
    </div>
</div>

<script>
    const STUDENT_COUNT = 27;
    // åˆå§‹ç§‘ç›® (å›ºå®š + é è¨­è‡ªè¨‚)
    let SUBJECTS = ['åœ‹èªä½œæ¥­ç°¿', 'æ•¸å››é¡Œ', 'æ—¥è¨˜', 'åœ‹èªç¿’ä½œ', 'è‡ªè¨‚1', 'è‡ªè¨‚2', 'è‡ªè¨‚3'];

    document.addEventListener('DOMContentLoaded', () => {
        initTableStructure();
        loadData();      // è®€å–è¨˜æ†¶
        updateSummary(); // æ›´æ–°çµ±è¨ˆ
    });

    function initTableStructure() {
        // 1. ç”Ÿæˆè¡¨é ­ (1~27è™Ÿ)
        const headerRow = document.querySelector('thead tr');
        while (headerRow.children.length > 1) {
            headerRow.removeChild(headerRow.lastChild);
        }
        
        for (let i = 1; i <= STUDENT_COUNT; i++) {
            const th = document.createElement('th');
            th.textContent = i < 10 ? `0${i}` : i;
            headerRow.appendChild(th);
        }

        // 2. ç”Ÿæˆè¡¨æ ¼å…§å®¹ (åˆ—=ç§‘ç›®)
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        SUBJECTS.forEach((subject, subjectIdx) => {
            const tr = document.createElement('tr');
            
            // ç¬¬ä¸€æ¬„ï¼šç§‘ç›®åç¨±
            const thSub = document.createElement('th');
            thSub.textContent = subject;
            thSub.id = `subj-header-${subjectIdx}`;
            tr.appendChild(thSub);

            // å¾ŒçºŒæ¬„ä½ï¼šå­¸ç”Ÿæ ¼å­
            for (let i = 1; i <= STUDENT_COUNT; i++) {
                const td = document.createElement('td');
                td.className = 'cell-clickable';
                td.dataset.status = "0"; // 0:ok, 1:missing, 2:uncorrected
                td.dataset.student = i;
                td.dataset.subjectIdx = subjectIdx;
                td.onclick = function() { toggleStatus(this); };
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
    }

    function toggleStatus(cell) {
        let current = parseInt(cell.dataset.status);
        let next = (current + 1) % 3;
        cell.dataset.status = next;
        
        updateSummary();
        saveData(); // é»æ“Šæ™‚å­˜æª”
    }

    function updateSubjectName(index, value) {
        SUBJECTS[index] = value;
        
        // æ›´æ–°å·¦å´æ¨™é¡Œé¡¯ç¤º
        const th = document.getElementById(`subj-header-${index}`);
        if(th) th.textContent = value;

        updateSummary();
        saveData(); // ä¿®æ”¹æ–‡å­—æ™‚å­˜æª”
    }

    function updateSummary() {
        const tbody = document.getElementById('tableBody');
        let report = `ğŸ“… ä½œæ¥­æª¢æŸ¥ (${new Date().toLocaleDateString()})\n------------------------\n`;
        let hasData = false;

        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, idx) => {
            const subjectName = row.querySelector('th').textContent;
            let missing = [];
            let uncorrected = [];

            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const status = parseInt(cell.dataset.status);
                const studentId = cell.dataset.student;
                if (status === 1) missing.push(studentId);
                if (status === 2) uncorrected.push(studentId);
            });

            if (missing.length > 0 || uncorrected.length > 0) {
                hasData = true;
                report += `ã€${subjectName}ã€‘\n`;
                if (missing.length > 0) report += `   âŒ æœªäº¤ï¼š${missing.join(', ')}\n`;
                if (uncorrected.length > 0) report += `   â–³ æœªè¨‚æ­£ï¼š${uncorrected.join(', ')}\n`;
                report += '\n';
            }
        });

        if (!hasData) report += "ğŸ‰ å…¨ç­ä½œæ¥­çš†å·²å®Œæˆï¼";
        document.getElementById('summaryText').value = report;
    }

    // --- å„²å­˜èˆ‡è®€å– (Local Storage) ---

    function saveData() {
        // 1. å­˜ç§‘ç›®åç¨±
        const customNames = [
            document.getElementById('custom1').value,
            document.getElementById('custom2').value,
            document.getElementById('custom3').value
        ];
        localStorage.setItem('hw_transposed_customs', JSON.stringify(customNames));

        // 2. å­˜æ ¼å­ç‹€æ…‹
        const gridData = [];
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const rowData = [];
            row.querySelectorAll('td').forEach(cell => {
                rowData.push(cell.dataset.status);
            });
            gridData.push(rowData);
        });
        localStorage.setItem('hw_transposed_grid', JSON.stringify(gridData));

        // é¡¯ç¤ºå­˜æª”æç¤º
        const msg = document.getElementById('saveMsg');
        msg.classList.add('show');
        setTimeout(() => msg.classList.remove('show'), 1000);
    }

    function loadData() {
        // 1. è®€å–ç§‘ç›®
        const savedHeaders = localStorage.getItem('hw_transposed_customs');
        if (savedHeaders) {
            const names = JSON.parse(savedHeaders);
            document.getElementById('custom1').value = names[0];
            document.getElementById('custom2').value = names[1];
            document.getElementById('custom3').value = names[2];
            
            // æ›´æ–°ç•«é¢ä¸Šçœ‹åˆ°çš„ç§‘ç›®
            updateSubjectName(4, names[0]);
            updateSubjectName(5, names[1]);
            updateSubjectName(6, names[2]);
        }

        // 2. è®€å–æ ¼å­
        const savedGrid = localStorage.getItem('hw_transposed_grid');
        if (savedGrid) {
            const gridData = JSON.parse(savedGrid);
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach((row, rIndex) => {
                if (gridData[rIndex]) {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, cIndex) => {
                        cell.dataset.status = gridData[rIndex][cIndex] || "0";
                    });
                }
            });
        }
    }

    function resetNewDay() {
        if(!confirm('ç¢ºå®šè¦é–‹å§‹æ–°çš„ä¸€å¤©å—ï¼Ÿ\n(é€™æœƒæ¸…ç©ºæ‰€æœ‰çš„ã€Œæœªäº¤/æœªè¨‚æ­£ã€è¨˜è™Ÿï¼Œä½†ä¿ç•™è‡ªè¨‚ç§‘ç›®åç¨±)')) return;
        
        const cells = document.querySelectorAll('td[data-status]');
        cells.forEach(cell => cell.dataset.status = "0");
        
        updateSummary();
        saveData();
    }

    function copySummary() {
        const copyText = document.getElementById("summaryText");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("å·²è¤‡è£½çµ±è¨ˆå…§å®¹ï¼");
        });
    }
</script>

</body>
</html>