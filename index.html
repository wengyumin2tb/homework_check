<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€äº”å¹´ä¸™ç­ã€‘ä½œæ¥­ç¹³äº¤çµ±è¨ˆè¡¨ (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f7fa;
            --border-color: #bbb;
            --missing-color: #ffcccc;
            --correction-color: #fff4cc;
            --header-bg: #4a90e2;
            --side-bg: #357abd;
        }

        body {
            font-family: "Microsoft JhengHei", "Segoe UI Emoji", Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* è¼‰å…¥é®ç½© */
        #loadingOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 8px;
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* é ‚éƒ¨è¨­å®š */
        .settings-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            font-size: 12px;
            background: #eee;
            padding: 5px;
            border-radius: 4px;
        }
        .settings-bar input {
            flex: 1;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .header-controls {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            min-height: 40px;
        }

        h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .corn-icon {
            font-size: 1.8rem;
            margin: 0 8px;
            display: inline-block;
            transform: rotate(-10deg);
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));
        }
        .corn-icon.right { transform: rotate(10deg); }

        .date-wrapper {
            position: absolute;
            right: 0;
            display: flex;
            align-items: center;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
            padding-left: 5px;
        }

        .date-picker {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-left: 5px;
        }

        /* åœ–ä¾‹ */
        .legend {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
            text-align: right;
        }
        .legend span { margin-left: 15px; display: inline-flex; align-items: center; }
        
        .demo-box {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            margin-right: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        /* è¡¨æ ¼æ ¸å¿ƒæ¨£å¼ */
        .table-wrapper {
            flex: 1;
            width: 100%;
            overflow: auto; 
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; 
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 0;
            text-align: center;
            font-size: 18px; 
            height: 35px;
            overflow: hidden;
            white-space: nowrap;
            vertical-align: middle;
        }

        col.subject-col { width: 110px; }
        col.student-col { width: auto; }

        thead th {
            background-color: var(--header-bg);
            color: white;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody th {
            background-color: var(--side-bg);
            color: white;
            text-align: left;
            padding-left: 10px;
            font-size: 14px;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        thead th:first-child { z-index: 20; left: 0; }

        .editable-header { cursor: text; }
        .editable-header:hover {
            background-color: #2a629c;
            text-decoration: underline;
        }

        td { cursor: pointer; transition: background 0.1s; }
        td:hover { background-color: #eee; border: 2px solid #555; }

        td.status-missing {
            background-color: var(--missing-color);
            color: #d32f2f;
            font-weight: bold;
        }
        
        td.status-correction {
            background-color: var(--correction-color);
            color: #e65100;
            font-weight: bold;
            font-size: 20px;
        }

        .summary-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #eee;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .summary-box {
            width: 100%;
            height: 100px;
            margin-top: 5px;
            padding: 5px;
            box-sizing: border-box;
            font-size: 13px;
            border: 1px solid #ccc;
            line-height: 1.5;
            font-family: inherit;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 5px;}
        .status-dot.online { background: #4caf50; }
        .status-dot.error { background: #f44336; }

    </style>
</head>
<body>

<div class="container">
    <div id="loadingOverlay">é›²ç«¯åŒæ­¥ä¸­...ğŸŒ½</div>

    <div class="settings-bar">
        <span id="apiStatus" class="status-dot" title="é€£ç·šç‹€æ…‹"></span>
        <label>Google Script ç¶²å€ï¼š</label>
        <input type="text" id="apiUrl" placeholder="è«‹è²¼ä¸Šéƒ¨ç½²å¾Œçš„ç¶²å€ (https://script.google.com/.../exec)">
        <button class="btn" onclick="saveApiUrl()">ç¶å®š</button>
    </div>

    <div class="header-controls">
        <h1>
            <span class="corn-icon">ğŸŒ½</span>
            ã€äº”å¹´ä¸™ç­ã€‘ä½œæ¥­ç¹³äº¤çµ±è¨ˆè¡¨
            <span class="corn-icon right">ğŸŒ½</span>
        </h1>
        <div class="date-wrapper">
            <label for="dateInput">æ—¥æœŸï¼š</label>
            <input type="date" id="dateInput" class="date-picker">
        </div>
    </div>

    <div class="legend">
        <span><div class="demo-box" style="background:white"></div> å®Œæˆ</span>
        <span><div class="demo-box" style="background:#ffcccc; color:#d32f2f">â–²</div> æœªäº¤</span>
        <span><div class="demo-box" style="background:#fff4cc; color:#e65100; font-size:18px;">â€»</div> æœªè¨‚æ­£</span>
    </div>

    <div class="table-wrapper">
        <table id="homeworkTable">
            <colgroup>
                <col class="subject-col">
            </colgroup>
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="summary-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="font-size:14px;">ğŸ“Š çµ±è¨ˆæ‘˜è¦ (ä¾ç§‘ç›®)</strong>
            <div>
                <button class="btn" onclick="copySummary()">è¤‡è£½æ‘˜è¦</button>
                <button class="btn" style="background-color:#f57c00" onclick="forceSave()">å¼·åˆ¶å„²å­˜</button>
            </div>
        </div>
        <textarea id="summaryText" class="summary-box" readonly placeholder="çµ±è¨ˆè³‡æ–™..."></textarea>
    </div>
</div>

<script>
    const STUDENT_COUNT = 28;
    // ç§‘ç›®è¨­å®š
    const SUBJECTS = [
        { key: 'chinese_wb', name: 'åœ‹èªä½œæ¥­ç°¿', editable: false },
        { key: 'math_4', name: 'æ•¸å››é¡Œ', editable: false },
        { key: 'diary', name: 'æ—¥è¨˜', editable: false },
        { key: 'chinese_prac', name: 'åœ‹èªç¿’ä½œ', editable: false },
        { key: 'res_1', name: 'ä¿ç•™1', editable: true, id: 'custom1' },
        { key: 'res_2', name: 'ä¿ç•™2', editable: true, id: 'custom2' },
        { key: 'res_3', name: 'ä¿ç•™3', editable: true, id: 'custom3' }
    ];
    
    const dateInput = document.getElementById('dateInput');
    const apiUrlInput = document.getElementById('apiUrl');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const apiStatus = document.getElementById('apiStatus');

    dateInput.valueAsDate = new Date();

    const STATUS_OK = 0;
    const STATUS_MISSING = 1;
    const STATUS_CORRECTION = 2;

    // å»¶é²å­˜æª”ç”¨ (é˜²æŠ–å‹•)
    let saveTimeout;

    // åˆå§‹åŒ–è¡¨æ ¼
    function initTable() {
        const table = document.getElementById('homeworkTable');
        
        const colgroup = table.querySelector('colgroup');
        colgroup.innerHTML = '<col class="subject-col">'; 
        for(let i=0; i<STUDENT_COUNT; i++){
            const col = document.createElement('col');
            col.className = 'student-col';
            colgroup.appendChild(col);
        }

        const theadRow = document.getElementById('headerRow');
        theadRow.innerHTML = '<th>é …ç›®</th>'; 
        for (let i = 1; i <= STUDENT_COUNT; i++) {
            const th = document.createElement('th');
            th.textContent = i;
            th.title = i + "è™Ÿ"; 
            theadRow.appendChild(th);
        }

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        SUBJECTS.forEach(sub => {
            const tr = document.createElement('tr');
            
            const thSub = document.createElement('th');
            thSub.textContent = sub.name;
            thSub.title = "é»æ“Šå¯ä¿®æ”¹åç¨±"; 
            if (sub.editable) {
                thSub.contentEditable = true;
                thSub.classList.add('editable-header');
                thSub.id = sub.id;
                thSub.addEventListener('input', function() {
                    localStorage.setItem('header_' + this.id, this.textContent); // æ¨™é¡Œä»å­˜æœ¬åœ°
                    generateSummary();
                });
            }
            tr.appendChild(thSub);

            for (let i = 1; i <= STUDENT_COUNT; i++) {
                const td = document.createElement('td');
                td.dataset.student = i;
                td.dataset.subject = sub.key;
                td.dataset.status = STATUS_OK;
                td.onclick = function() { toggleStatus(this); };
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ API URL
        const savedUrl = localStorage.getItem('gas_api_url');
        if (savedUrl) {
            apiUrlInput.value = savedUrl;
            apiStatus.classList.add('online');
            loadDataFromCloud();
        } else {
            alert("åˆæ¬¡ä½¿ç”¨è«‹è¼¸å…¥ Google Apps Script ç¶²å€ä»¥å•Ÿç”¨é›²ç«¯åŒæ­¥ã€‚");
        }

        loadCustomHeaders();
    }

    function toggleStatus(cell) {
        let currentStatus = parseInt(cell.dataset.status);
        let nextStatus = (currentStatus + 1) % 3;
        updateCellVisual(cell, nextStatus);
        
        // è‡ªå‹•å­˜æª” (å»¶é² 1 ç§’ï¼Œé¿å…é€£çºŒé»æ“Šæ™‚é »ç¹ç™¼é€è«‹æ±‚)
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveDataToCloud, 1000);
        
        generateSummary();
    }

    function updateCellVisual(cell, status) {
        cell.dataset.status = status;
        cell.className = ''; 
        cell.textContent = ''; 

        if (status === STATUS_MISSING) {
            cell.classList.add('status-missing');
            cell.textContent = 'â–²'; 
        } else if (status === STATUS_CORRECTION) {
            cell.classList.add('status-correction');
            cell.textContent = 'â€»'; 
        }
    }

    // --- é›²ç«¯åŠŸèƒ½å€ ---

    function saveApiUrl() {
        const url = apiUrlInput.value.trim();
        if (url) {
            localStorage.setItem('gas_api_url', url);
            apiStatus.classList.add('online');
            alert("ç¶²å€å·²å„²å­˜ï¼å˜—è©¦è¼‰å…¥è³‡æ–™...");
            loadDataFromCloud();
        }
    }

    // å¾é›²ç«¯è¼‰å…¥
    function loadDataFromCloud() {
        const url = localStorage.getItem('gas_api_url');
        if (!url) return;
        
        const date = dateInput.value;
        loadingOverlay.style.display = 'flex'; // é¡¯ç¤ºé®ç½©

        fetch(`${url}?action=read&date=${date}`)
        .then(response => response.json())
        .then(data => {
            applyDataToTable(data);
            loadingOverlay.style.display = 'none';
        })
        .catch(err => {
            console.error(err);
            loadingOverlay.style.display = 'none';
            apiStatus.classList.remove('online');
            apiStatus.classList.add('error');
            alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯é€£ç·šã€‚");
        });
    }

    // å„²å­˜åˆ°é›²ç«¯
    function saveDataToCloud() {
        const url = localStorage.getItem('gas_api_url');
        if (!url) return;

        const date = dateInput.value;
        const data = collectTableData();

        // é¡¯ç¤ºå°å°çš„æç¤ºæˆ–æ”¹è®Šç‹€æ…‹ç‡ˆ
        apiStatus.style.opacity = 0.5;

        // ä½¿ç”¨ fetch POST ç™¼é€è³‡æ–™
        // æ³¨æ„ï¼šGAS Web App éœ€è¦ç”¨ 'no-cors' æˆ– text/plain ä¾†é¿å…è·¨åŸŸè¤‡é›œå•é¡Œï¼Œ
        // ä½†ç‚ºäº†ç¢ºä¿è³‡æ–™å¯«å…¥ï¼Œæˆ‘å€‘å‚³é€ Stringified JSON
        fetch(url + '?action=save&date=' + date, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            apiStatus.style.opacity = 1;
            console.log("Saved:", result);
        })
        .catch(err => {
            console.error("Save Error:", err);
            apiStatus.classList.add('error');
            alert("å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        });
    }
    
    // å¼·åˆ¶å„²å­˜æŒ‰éˆ•
    function forceSave() {
        saveDataToCloud();
        alert("å·²é€å‡ºå„²å­˜è«‹æ±‚ã€‚");
    }

    function collectTableData() {
        const data = {};
        const cells = document.querySelectorAll('td[data-subject]');
        cells.forEach(cell => {
            const status = parseInt(cell.dataset.status);
            if (status !== STATUS_OK) {
                const student = cell.dataset.student;
                const subject = cell.dataset.subject;
                if (!data[student]) data[student] = {};
                data[student][subject] = status;
            }
        });
        return data;
    }

    function applyDataToTable(data) {
        // é‡ç½®
        const cells = document.querySelectorAll('td[data-subject]');
        cells.forEach(cell => updateCellVisual(cell, STATUS_OK));

        // å¡«å…¥
        if (!data) return; // ç©ºè³‡æ–™

        for (const student in data) {
            for (const subject in data[student]) {
                const status = data[student][subject];
                const cell = document.querySelector(`td[data-student="${student}"][data-subject="${subject}"]`);
                if (cell) updateCellVisual(cell, status);
            }
        }
        generateSummary();
    }

    // --- çµ±è¨ˆæ‘˜è¦å€ ---

    function generateSummary() {
        const date = dateInput.value;
        let report = `ğŸ“… ${date} ã€äº”å¹´ä¸™ç­ã€‘ä½œæ¥­ç¹³äº¤çµ±è¨ˆï¼š\n`;
        let hasData = false;

        SUBJECTS.forEach(sub => {
            let subjectName = sub.name;
            if (sub.editable) {
                const el = document.getElementById(sub.id);
                if (el && el.textContent) subjectName = el.textContent;
            }

            let missingList = [];
            let correctionList = [];

            for (let i = 1; i <= STUDENT_COUNT; i++) {
                const cell = document.querySelector(`td[data-student="${i}"][data-subject="${sub.key}"]`);
                if (cell) {
                    const status = parseInt(cell.dataset.status);
                    if (status === STATUS_MISSING) {
                        missingList.push(i);
                    } else if (status === STATUS_CORRECTION) {
                        correctionList.push(i);
                    }
                }
            }

            if (missingList.length > 0 || correctionList.length > 0) {
                let line = `ã€${subjectName}ã€‘`;
                let parts = [];
                
                if (missingList.length > 0) {
                    parts.push(`æœªäº¤(â–²): ${missingList.join('ã€')}`);
                }
                if (correctionList.length > 0) {
                    parts.push(`æœªè¨‚(â€»): ${correctionList.join('ã€')}`);
                }
                
                report += line + parts.join('  /  ') + '\n';
                hasData = true;
            }
        });

        if (!hasData) report += "å…¨ç­ä½œæ¥­çš†å·²å®Œæˆï¼";
        document.getElementById('summaryText').value = report;
    }

    function copySummary() {
        const copyText = document.getElementById("summaryText");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("å·²è¤‡è£½æ‘˜è¦ï¼");
        });
    }

    function loadCustomHeaders() {
        SUBJECTS.filter(s => s.editable).forEach(sub => {
            const storedName = localStorage.getItem('header_' + sub.id);
            if (storedName) {
                const el = document.getElementById(sub.id);
                if(el) el.textContent = storedName;
            }
        });
    }

    dateInput.addEventListener('change', loadDataFromCloud);
    initTable();
</script>

</body>
</html>