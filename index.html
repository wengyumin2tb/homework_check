<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€äº”å¹´ä¸™ç­ã€‘ä½œæ¥­ç¹³äº¤çµ±è¨ˆè¡¨</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f7fa;
            --border-color: #bbb;
            --missing-color: #ffcccc; /* æ·ºç´…åº• */
            --correction-color: #fff4cc; /* æ·ºé»ƒåº• */
            --header-bg: #4a90e2;
            --side-bg: #357abd;
        }

        body {
            font-family: "Microsoft JhengHei", "Segoe UI Emoji", Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨æ§åˆ¶å€ (æ¨™é¡Œç½®ä¸­ + ç‰ç±³åœ–æ¡ˆ) */
        .header-controls {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            min-height: 40px;
        }

        h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Qç‰ˆç‰ç±³åœ–æ¡ˆæ¨£å¼ */
        .corn-icon {
            font-size: 1.8rem;
            margin: 0 8px;
            display: inline-block;
            /* å¢åŠ ä¸€é»å¯æ„›çš„å‚¾æ–œæ„Ÿ */
            transform: rotate(-10deg);
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));
        }
        .corn-icon.right {
             transform: rotate(10deg);
        }

        /* æ—¥æœŸé¸æ“‡å™¨ç§»åˆ°å³å´ */
        .date-wrapper {
            position: absolute;
            right: 0;
            display: flex;
            align-items: center;
            font-size: 14px;
            background: rgba(255,255,255,0.8); /* é˜²æ­¢æ“‹ä½æ¨™é¡Œæ™‚çœ‹ä¸æ¸… */
            padding-left: 5px;
        }

        .date-picker {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-left: 5px;
        }

        /* åœ–ä¾‹ */
        .legend {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
            text-align: right;
        }
        .legend span { margin-left: 15px; display: inline-flex; align-items: center; }
        
        /* åœ–ä¾‹çš„å°ç¤ºç¯„æ ¼ */
        .demo-box {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            margin-right: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        /* è¡¨æ ¼æ ¸å¿ƒæ¨£å¼ */
        .table-wrapper {
            flex: 1; /* ä½”æ»¿å‰©é¤˜é«˜åº¦ */
            width: 100%;
            overflow: auto; 
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* å›ºå®šä½ˆå±€ */
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 0;
            text-align: center;
            font-size: 18px; /* ç¬¦è™Ÿç¨å¾®å¤§ä¸€é» */
            height: 35px;
            overflow: hidden;
            white-space: nowrap;
            vertical-align: middle;
        }

        /* èª¿æ•´æ¬„å¯¬æ¯”ä¾‹ */
        col.subject-col { width: 110px; }
        col.student-col { width: auto; }

        /* è¡¨é ­ (åº§è™Ÿ) */
        thead th {
            background-color: var(--header-bg);
            color: white;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* å·¦å´ (ç§‘ç›®) */
        tbody th {
            background-color: var(--side-bg);
            color: white;
            text-align: left;
            padding-left: 10px;
            font-size: 14px;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        /* å·¦ä¸Šè§’ç©ºç™½æ ¼ */
        thead th:first-child {
            z-index: 20;
            left: 0;
        }

        /* å¯ç·¨è¼¯çš„æ¨™é¡Œ */
        .editable-header {
            cursor: text;
        }
        .editable-header:hover {
            background-color: #2a629c;
            text-decoration: underline;
        }

        td {
            cursor: pointer;
            transition: background 0.1s;
        }

        td:hover {
            background-color: #eee;
            border: 2px solid #555;
        }

        /* ç‹€æ…‹æ¨£å¼ - é¡¯ç¤ºç¬¦è™Ÿ */
        td.status-missing {
            background-color: var(--missing-color);
            color: #d32f2f; /* æ·±ç´…è‰² */
            font-weight: bold;
        }
        
        td.status-correction {
            background-color: var(--correction-color);
            color: #e65100; /* æ·±æ©˜è‰² */
            font-weight: bold;
            font-size: 20px; /* â€» ç¬¦è™Ÿç¨å¾®åŠ å¤§ */
        }

        /* åº•éƒ¨çµ±è¨ˆå€ */
        .summary-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #eee;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .summary-box {
            width: 100%;
            height: 100px;
            margin-top: 5px;
            padding: 5px;
            box-sizing: border-box;
            font-size: 13px;
            border: 1px solid #ccc;
            line-height: 1.5;
            font-family: inherit;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-clear { background-color: #757575; }

    </style>
</head>
<body>

<div class="container">
    <div class="header-controls">
        <h1>
            <span class="corn-icon">ğŸŒ½</span>
            ã€äº”å¹´ä¸™ç­ã€‘ä½œæ¥­ç¹³äº¤çµ±è¨ˆè¡¨
            <span class="corn-icon right">ğŸŒ½</span>
        </h1>
        <div class="date-wrapper">
            <label for="dateInput">æ—¥æœŸï¼š</label>
            <input type="date" id="dateInput" class="date-picker">
        </div>
    </div>

    <div class="legend">
        <span><div class="demo-box" style="background:white"></div> å®Œæˆ</span>
        <span><div class="demo-box" style="background:#ffcccc; color:#d32f2f">â–²</div> æœªäº¤</span>
        <span><div class="demo-box" style="background:#fff4cc; color:#e65100; font-size:18px;">â€»</div> æœªè¨‚æ­£</span>
    </div>

    <div class="table-wrapper">
        <table id="homeworkTable">
            <colgroup>
                <col class="subject-col">
                </colgroup>
            <thead>
                <tr id="headerRow">
                    </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div class="summary-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="font-size:14px;">ğŸ“Š çµ±è¨ˆæ‘˜è¦ (ä¾ç§‘ç›®)</strong>
            <div>
                <button class="btn" onclick="copySummary()">è¤‡è£½æ‘˜è¦</button>
                <button class="btn btn-clear" onclick="clearToday()">æ¸…ç©ºä»Šæ—¥</button>
            </div>
        </div>
        <textarea id="summaryText" class="summary-box" readonly placeholder="çµ±è¨ˆè³‡æ–™..."></textarea>
    </div>
</div>

<script>
    const STUDENT_COUNT = 28;
    // ç§‘ç›®è¨­å®š
    const SUBJECTS = [
        { key: 'chinese_wb', name: 'åœ‹èªä½œæ¥­ç°¿', editable: false },
        { key: 'math_4', name: 'æ•¸å››é¡Œ', editable: false },
        { key: 'diary', name: 'æ—¥è¨˜', editable: false },
        { key: 'chinese_prac', name: 'åœ‹èªç¿’ä½œ', editable: false },
        { key: 'res_1', name: 'ä¿ç•™1', editable: true, id: 'custom1' },
        { key: 'res_2', name: 'ä¿ç•™2', editable: true, id: 'custom2' },
        { key: 'res_3', name: 'ä¿ç•™3', editable: true, id: 'custom3' }
    ];
    
    const dateInput = document.getElementById('dateInput');
    dateInput.valueAsDate = new Date();

    const STATUS_OK = 0;
    const STATUS_MISSING = 1;
    const STATUS_CORRECTION = 2;

    // åˆå§‹åŒ–è¡¨æ ¼
    function initTable() {
        const table = document.getElementById('homeworkTable');
        
        // 0. è¨­å®š Colgroup
        const colgroup = table.querySelector('colgroup');
        colgroup.innerHTML = '<col class="subject-col">'; 
        for(let i=0; i<STUDENT_COUNT; i++){
            const col = document.createElement('col');
            col.className = 'student-col';
            colgroup.appendChild(col);
        }

        // 1. ç”Ÿæˆè¡¨é ­ (åº§è™Ÿ)
        const theadRow = document.getElementById('headerRow');
        theadRow.innerHTML = '<th>é …ç›®</th>'; 
        for (let i = 1; i <= STUDENT_COUNT; i++) {
            const th = document.createElement('th');
            th.textContent = i;
            th.title = i + "è™Ÿ"; 
            theadRow.appendChild(th);
        }

        // 2. ç”Ÿæˆå…§å®¹
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        SUBJECTS.forEach(sub => {
            const tr = document.createElement('tr');
            
            // ç§‘ç›®åç¨±æ¬„ä½
            const thSub = document.createElement('th');
            thSub.textContent = sub.name;
            thSub.title = "é»æ“Šå¯ä¿®æ”¹åç¨±"; 
            if (sub.editable) {
                thSub.contentEditable = true;
                thSub.classList.add('editable-header');
                thSub.id = sub.id;
                thSub.addEventListener('input', function() {
                    localStorage.setItem('header_' + this.id, this.textContent);
                    generateSummary();
                });
            }
            tr.appendChild(thSub);

            // å­¸ç”Ÿæ ¼å­
            for (let i = 1; i <= STUDENT_COUNT; i++) {
                const td = document.createElement('td');
                td.dataset.student = i;
                td.dataset.subject = sub.key;
                td.dataset.status = STATUS_OK;
                td.onclick = function() { toggleStatus(this); };
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
        
        loadData(); 
        loadCustomHeaders();
    }

    function toggleStatus(cell) {
        let currentStatus = parseInt(cell.dataset.status);
        let nextStatus = (currentStatus + 1) % 3;
        updateCellVisual(cell, nextStatus);
        saveData();
        generateSummary();
    }

    function updateCellVisual(cell, status) {
        cell.dataset.status = status;
        cell.className = ''; 
        cell.textContent = ''; 

        if (status === STATUS_MISSING) {
            cell.classList.add('status-missing');
            // æ›´æ–°ç‚ºå¯¦å¿ƒä¸‰è§’å½¢
            cell.textContent = 'â–²'; 
        } else if (status === STATUS_CORRECTION) {
            cell.classList.add('status-correction');
            // æ›´æ–°ç‚ºç±³å­—è™Ÿ
            cell.textContent = 'â€»'; 
        }
    }

    function saveData() {
        const date = dateInput.value;
        const data = {};
        const cells = document.querySelectorAll('td[data-subject]');
        cells.forEach(cell => {
            const status = parseInt(cell.dataset.status);
            if (status !== STATUS_OK) {
                const student = cell.dataset.student;
                const subject = cell.dataset.subject;
                if (!data[student]) data[student] = {};
                data[student][subject] = status;
            }
        });
        localStorage.setItem('hw_record_' + date, JSON.stringify(data));
    }

    function loadData() {
        const date = dateInput.value;
        const stored = localStorage.getItem('hw_record_' + date);
        const data = stored ? JSON.parse(stored) : {};

        const cells = document.querySelectorAll('td[data-subject]');
        cells.forEach(cell => updateCellVisual(cell, STATUS_OK));

        for (const student in data) {
            for (const subject in data[student]) {
                const status = data[student][subject];
                const cell = document.querySelector(`td[data-student="${student}"][data-subject="${subject}"]`);
                if (cell) updateCellVisual(cell, status);
            }
        }
        generateSummary();
    }

    // ä¾ç§‘ç›®çµ±è¨ˆé‚è¼¯ (æ›´æ–°æ‘˜è¦æ–‡å­—ä¸­çš„ç¬¦è™Ÿ)
    function generateSummary() {
        const date = dateInput.value;
        let report = `ğŸ“… ${date} ã€äº”å¹´ä¸™ç­ã€‘ä½œæ¥­ç¹³äº¤çµ±è¨ˆï¼š\n`;
        let hasData = false;

        SUBJECTS.forEach(sub => {
            let subjectName = sub.name;
            if (sub.editable) {
                const el = document.getElementById(sub.id);
                if (el && el.textContent) subjectName = el.textContent;
            }

            let missingList = [];
            let correctionList = [];

            for (let i = 1; i <= STUDENT_COUNT; i++) {
                const cell = document.querySelector(`td[data-student="${i}"][data-subject="${sub.key}"]`);
                if (cell) {
                    const status = parseInt(cell.dataset.status);
                    if (status === STATUS_MISSING) {
                        missingList.push(i);
                    } else if (status === STATUS_CORRECTION) {
                        correctionList.push(i);
                    }
                }
            }

            if (missingList.length > 0 || correctionList.length > 0) {
                let line = `ã€${subjectName}ã€‘`;
                let parts = [];
                
                // æ›´æ–°æ‘˜è¦ä¸­çš„ç¬¦è™Ÿ
                if (missingList.length > 0) {
                    parts.push(`æœªäº¤(â–²): ${missingList.join('ã€')}`);
                }
                if (correctionList.length > 0) {
                    parts.push(`æœªè¨‚(â€»): ${correctionList.join('ã€')}`);
                }
                
                report += line + parts.join('  /  ') + '\n';
                hasData = true;
            }
        });

        if (!hasData) report += "å…¨ç­ä½œæ¥­çš†å·²å®Œæˆï¼";
        document.getElementById('summaryText').value = report;
    }

    function copySummary() {
        const copyText = document.getElementById("summaryText");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("å·²è¤‡è£½æ‘˜è¦ï¼");
        });
    }

    function clearToday() {
        if(confirm("æ¸…ç©ºä»Šæ—¥ç´€éŒ„ï¼Ÿ")) {
            const date = dateInput.value;
            localStorage.removeItem('hw_record_' + date);
            loadData();
        }
    }

    function loadCustomHeaders() {
        SUBJECTS.filter(s => s.editable).forEach(sub => {
            const storedName = localStorage.getItem('header_' + sub.id);
            if (storedName) {
                const el = document.getElementById(sub.id);
                if(el) el.textContent = storedName;
            }
        });
    }

    dateInput.addEventListener('change', loadData);
    initTable();
</script>

</body>
</html>